<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rainbow 99</title>
    <style>
        :root {
            /* Rainbow Colors */
            --p1-color: #FF5252; /* Red */
            --p2-color: #FF9800; /* Orange */
            --p3-color: #FFEB3B; /* Yellow */
            --p4-color: #4CAF50; /* Green */
            --p5-color: #2196F3; /* Blue */
            --p6-color: #3F51B5; /* Indigo */
            --p7-color: #9C27B0; /* Violet */
            
            --bg-dark: #1a1a2e;
            --text-white: #ffffff;
            --glass: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Segoe UI', 'Roboto', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, #2a2a4e 0%, #1a1a2e 100%);
            color: var(--text-white);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent scroll on body, handle in containers */
        }

        /* --- STRICT FONT SIZING --- */
        body, p, div, span, input, select, label, li {
            font-size: 16px; 
            line-height: 1.5;
        }

        h1, h2, h3, button, .card-val, .score-display {
            font-size: 21px; 
            font-weight: bold;
        }

        /* --- LAYOUT UTILS --- */
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .flex-col { display: flex; flex-direction: column; }
        .full-screen { width: 100%; height: 100vh; position: absolute; top: 0; left: 0; z-index: 100; }

        /* --- SCREENS --- */
        #start-screen, #game-over-screen, #round-result-screen {
            background: rgba(0,0,0,0.95);
            z-index: 50;
            padding: 20px;
            text-align: center;
        }

        /* Start Screen Footer */
        .start-footer {
            margin-top: auto;
            padding-bottom: 20px;
            opacity: 0.7;
            font-size: 16px;
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- COMPONENTS --- */
        
        button {
            background: linear-gradient(45deg, #ff00cc, #3333ff);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 0, 204, 0.6);
        }

        button:active {
            transform: scale(0.95);
        }

        /* Card Design */
        .card {
            width: 90px;
            height: 130px;
            background: white;
            border-radius: 10px;
            color: #333;
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 5px;
            cursor: pointer;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            border: 2px solid #ccc;
            user-select: none;
        }

        /* Specific card for the center play area */
        .card-played {
            width: 100px;
            height: 140px;
            transform: scale(1.2);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.4);
            z-index: 20;
        }

        .card:hover {
            transform: translateY(-10px) scale(1.05);
            z-index: 10;
        }

        .card-top, .card-bottom {
            position: absolute;
            font-size: 16px;
            font-weight: bold;
        }
        
        .card-top { top: 5px; left: 5px; }
        .card-bottom { bottom: 5px; right: 5px; transform: rotate(180deg); }

        .card-center {
            font-size: 34px !important; /* Update to 34px */
            font-weight: 900;
            text-align: center;
        }

        .card[data-type="pos"] { border-color: #4CAF50; color: #2E7D32; }
        .card[data-type="neg"] { border-color: #F44336; color: #C62828; }
        .card[data-type="effect"] { border-color: #2196F3; color: #1565C0; background: #E3F2FD; }

        /* --- GAME BOARD --- */
        .game-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 20px;
            z-index: 30;
            pointer-events: none; /* Let clicks pass through to board if needed */
        }
        
        .header-bg {
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            padding: 8px 15px;
            border-radius: 12px;
            pointer-events: auto;
            margin-bottom: 5px;
        }

        .deck-info {
            text-align: right;
        }

        /* --- CIRCULAR TABLE LAYOUT --- */
        .table-area {
            position: relative;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 160px; /* Space for hand */
            overflow: hidden;
        }

        .circle-container {
            position: relative;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            /* border: 2px dashed rgba(255,255,255,0.1); */ /* Guide line optional */
        }

        /* Central Info Box */
        .center-stage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 200px;
            height: 200px;
            z-index: 10;
        }

        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(0,0,0,0.8);
            border: 4px solid white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 30px rgba(255,255,255,0.2);
            margin-bottom: 10px;
            z-index: 25;
            position: relative;
        }

        .current-number {
            font-size: 32px; /* Bigger for visibility */
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px currentColor;
        }
        
        .direction-arrow {
            position: absolute;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 2px dashed rgba(255,255,255,0.3);
            animation: spin 10s linear infinite;
            pointer-events: none;
        }

        .direction-text {
            position: absolute;
            bottom: -30px; /* Move text below the ring/card */
            font-size: 16px;
            color: #FFEB3B;
            font-weight: bold;
            text-shadow: 0 0 5px black;
            z-index: 30;
            background: rgba(0,0,0,0.5);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .played-card-spot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 21; /* Behind score circle? No, let's put score on top or card on top? */
            /* New Design: Card in exact center, Score slightly above or overlay */
        }
        
        .active-card-display {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 20;
        }

        /* Player Avatars */
        .player-avatar {
            position: absolute;
            width: 90px;
            height: 90px;
            /* Centering calculation handled in JS */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(30, 30, 50, 0.9);
            border: 2px solid #555;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            padding: 5px;
            z-index: 5;
        }

        .player-avatar.active {
            transform: scale(1.2);
            box-shadow: 0 0 20px currentColor;
            z-index: 6;
            border-width: 3px;
        }

        .player-info-box {
            position: absolute;
            bottom: -35px;
            background: rgba(0,0,0,0.8);
            padding: 2px 8px;
            border-radius: 10px;
            white-space: nowrap;
            text-align: center;
            font-size: 14px; /* Small detail text */
            z-index: 7;
        }

        .avatar-name { font-weight: bold; font-size: 16px; margin-bottom: 2px; }
        .avatar-money { color: #4CAF50; font-size: 14px; }
        .avatar-cards { font-size: 14px; color: #ddd; }

        /* Hand Area */
        .hand-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px 10px 20px 10px;
            background: linear-gradient(to top, rgba(22, 33, 62, 1), rgba(22, 33, 62, 0.8));
            display: flex;
            overflow-x: auto;
            justify-content: center;
            align-items: flex-end;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            z-index: 40;
            min-height: 160px;
        }

        .hand-scroll-container {
            display: flex;
            padding-bottom: 10px;
        }

        /* Game Log Toast style */
        .game-log-toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 10px 20px;
            border-radius: 20px;
            pointer-events: none;
            z-index: 35;
            text-align: center;
            max-width: 90%;
            font-size: 16px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes spinCCW { 100% { transform: rotate(-360deg); } }

        /* Responsive */
        @media (max-width: 768px) {
            .circle-container { width: 340px; height: 340px; }
            .player-avatar { width: 70px; height: 70px; }
            .avatar-name { font-size: 14px; }
            .card { width: 65px; height: 90px; }
            .card-center { font-size: 34px !important; }
            .hand-area { justify-content: flex-start; }
            .game-header { flex-direction: column; align-items: stretch; gap: 5px; }
            .deck-info { text-align: left; }
            .current-number { font-size: 24px; }
            .score-circle { width: 80px; height: 80px; }
            .card-played { width: 80px; height: 110px; }
        }
    </style>
</head>
<body>

    <!-- START SCREEN -->
    <div id="start-screen" class="full-screen flex-center flex-col">
        <h1 style="color:var(--p3-color); margin-bottom:20px; font-size: 32px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(255,255,255,0.5);">Rainbow 99 üåà</h1>
        
        <p style="margin-bottom: 30px; max-width: 600px; line-height: 1.8; text-align: center; padding: 0 20px;">
            Ê≠°Ëøé‰æÜÂà∞„ÄäÂΩ©Ëôπ99„Äã<br>
            ÊØèÂ±Ä7Áé©ÂÆ∂ÔºåÊØè‰∫∫7ÂºµÁâåÔºåÁõÆÊ®ôÊòØ‰∏çË¶ÅËÆìÊï∏Â≠óË∂ÖÈÅé99ÔºåË™∞‰∫∫ËÆìÊï∏Â≠óÂà∞100Ë™∞‰∫∫Ëº∏ÔºåËº∏ÂÆ∂Â∞áÊ†πÊìöÈö®Ê©üÂÄçÁéáÊâ£Èô§ÈáëÈå¢Ôºå‰∏¶ËΩâÁßªÁµ¶ÂÆ≥‰Ω†Ëº∏ÁöÑ‰∫∫ÔºåÈõ¢‰∫∫Ë¥èÂæó $2000 ÊàñËº∏ÂÖâ $1000 Âç≥ÁµêÊùüÈÅäÊà≤„ÄÇ
        </p>
        
        <div style="display:flex; flex-wrap:wrap; justify-content:center;">
            <button onclick="game.init(1)">Êàë vs ÈõªËÖ¶ (1‰∫∫)</button>
            <button onclick="game.init(2)">Êàë vs ÊúãÂèã vs ÈõªËÖ¶ (2‰∫∫)</button>
        </div>
        
        <div class="start-footer">
            Design by Derek<br>
            V1.2
        </div>
    </div>

    <!-- GAME UI -->
    <div id="game-ui" class="container hidden">
        <!-- Header Info -->
        <div class="game-header">
            <div class="header-bg">
                <div style="font-size:16px; opacity:0.8;">ÁçéÈáëË¶èÂâá: Èö®Ê©ü x1, x2, x3</div>
            </div>
            <div class="header-bg deck-info">
                <div style="font-size:16px;">ÁâåÂ∫´È§òÈáè: <span id="deck-count" style="color:var(--p3-color); font-weight:bold;">144</span></div>
            </div>
        </div>

        <!-- Latest Action Log -->
        <div id="toast-log" class="game-log-toast">ÈÅäÊà≤ÈñãÂßãÔºÅËµ∑ÂßãÊï∏Â≠ó 7</div>

        <!-- Table Area (Circular) -->
        <div class="table-area">
            <div class="circle-container" id="table-circle">
                <!-- Center Info -->
                <div class="center-stage">
                    <div id="score-circle-display" class="score-circle">
                        <div style="font-size:14px; opacity:0.8;">ÁõÆÂâçÊï∏Â≠ó</div>
                        <div id="current-score" class="current-number">7</div>
                    </div>
                    <!-- Played card appears here -->
                    <div id="active-card-container" class="active-card-display"></div>
                    <!-- Direction Indicator ring -->
                    <div id="direction-ring" class="direction-arrow"></div>
                    <!-- Direction Text -->
                    <div id="direction-text" class="direction-text">‚Üª È†ÜÊôÇÈáù</div>
                </div>
                <!-- Players will be injected here absolutely -->
            </div>
        </div>

        <!-- Player Hand -->
        <div class="hand-area">
            <div id="player-hand" class="hand-scroll-container">
                <!-- Cards rendered here -->
            </div>
        </div>
    </div>

    <!-- ROUND RESULT SCREEN -->
    <div id="round-result-screen" class="full-screen flex-center flex-col hidden">
        <h2 style="color:var(--p1-color); margin-bottom:15px;">Êú¨Â±ÄÁµêÊùüÔºÅ</h2>
        <div id="result-details" style="margin-bottom:20px; background:rgba(255,255,255,0.1); padding:20px; border-radius:10px;">
            <!-- Details -->
        </div>
        <button onclick="game.nextRound()">‰∏ã‰∏ÄÂ±Ä</button>
    </div>

    <!-- GAME OVER SCREEN -->
    <div id="game-over-screen" class="full-screen flex-center flex-col hidden">
        <h1 style="color:var(--p3-color); margin-bottom:20px;">ÈÅäÊà≤ÁµêÊùü (Game Over)</h1>
        <p id="winner-announce" style="margin-bottom:20px; font-size:21px;"></p>
        <div id="final-stats" style="width:90%; max-width:600px; margin-bottom:20px; overflow-y:auto; max-height:50vh;"></div>
        <button onclick="location.reload()">ÈáçÁé©</button>
    </div>

    <script>
        /**
         * Rainbow 99 Game Logic V1.2
         */

        const CONFIG = {
            START_MONEY: 1000,
            WIN_MONEY: 2000,
            LOSE_MONEY: 0,
            START_SCORE: 7,
            MAX_SCORE: 99,
            HAND_SIZE: 7
        };

        const CARD_TYPES = {
            POS: 'pos',
            NEG: 'neg',
            EFFECT: 'effect'
        };

        const EFFECTS = {
            REVERSE: 'Reverse',
            ADD13: '+13',
            SKIP: 'Skip Me',
            SET99: '99',
            SET0: '0',
            REMOVE: 'Remove Card'
        };

        const PLAYER_COLORS = [
            { name: "Red", color: "#FF5252" },
            { name: "Orange", color: "#FF9800" },
            { name: "Yellow", color: "#FFEB3B" },
            { name: "Green", color: "#4CAF50" },
            { name: "Blue", color: "#2196F3" },
            { name: "Indigo", color: "#3F51B5" },
            { name: "Violet", color: "#9C27B0" }
        ];

        class Card {
            constructor(label, value, type, effect = null) {
                this.label = label;
                this.value = value;
                this.type = type;
                this.effect = effect;
                this.id = Math.random().toString(36).substr(2, 9);
            }
        }

        class Player {
            constructor(index, isHuman) {
                this.index = index;
                this.name = `ÈõªËÖ¶ ${index+1}`;
                this.isHuman = isHuman;
                
                // Specific Naming
                if (isHuman) {
                    if (index === 0) this.name = `Êàë (${PLAYER_COLORS[index].name})`;
                    else if (index === 2) this.name = `ÊúãÂèã (${PLAYER_COLORS[index].name})`;
                }

                this.money = CONFIG.START_MONEY;
                this.hand = [];
                this.colorData = PLAYER_COLORS[index];
            }
        }

        const game = {
            mode: 1,
            players: [],
            deck: [],
            discardPile: [],
            currentScore: 7,
            direction: 1, 
            currentPlayerIndex: 0,
            lastPlayerIndex: null, // Who played the last card (potential winner)
            isProcessing: false,

            init: function(selectedMode) {
                this.mode = selectedMode;
                this.players = [];
                
                // P0=Human, P2=Friend(if mode2), others AI
                for (let i = 0; i < 7; i++) {
                    let isHuman = false;
                    if (selectedMode === 1 && i === 0) isHuman = true;
                    if (selectedMode === 2) {
                        if (i === 0) isHuman = true; // Me
                        if (i === 2) isHuman = true; // Friend (3rd player, Index 2)
                    }
                    this.players.push(new Player(i, isHuman));
                }

                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('game-ui').classList.remove('hidden');
                this.startRound();
                this.renderCircularTable();
            },

            generateDeck: function() {
                this.deck = [];
                // 1. Positive Cards (+1 to +9), 7 of each
                for (let i = 1; i <= 9; i++) {
                    for (let j = 0; j < 7; j++) this.deck.push(new Card(`+${i}`, i, CARD_TYPES.POS));
                }
                // 2. Negative Cards (-1 to -9), 5 of each
                for (let i = 1; i <= 9; i++) {
                    for (let j = 0; j < 5; j++) this.deck.push(new Card(`-${i}`, -i, CARD_TYPES.NEG));
                }
                // 3. Effect Cards, 6 of each
                for(let j=0; j<6; j++) this.deck.push(new Card('‚ü≤', 0, CARD_TYPES.EFFECT, EFFECTS.REVERSE));
                for(let j=0; j<6; j++) this.deck.push(new Card('+13', 13, CARD_TYPES.POS, EFFECTS.ADD13));
                for(let j=0; j<6; j++) this.deck.push(new Card('Skip', 0, CARD_TYPES.EFFECT, EFFECTS.SKIP));
                for(let j=0; j<6; j++) this.deck.push(new Card('99', 99, CARD_TYPES.EFFECT, EFFECTS.SET99));
                for(let j=0; j<6; j++) this.deck.push(new Card('0', 0, CARD_TYPES.EFFECT, EFFECTS.SET0));
                for(let j=0; j<6; j++) this.deck.push(new Card('Rem', 0, CARD_TYPES.EFFECT, EFFECTS.REMOVE));
                
                // Shuffle
                this.deck.sort(() => Math.random() - 0.5);
                this.updateDeckCount();
            },

            updateDeckCount: function() {
                document.getElementById('deck-count').innerText = this.deck.length;
            },

            drawCard: function(player) {
                if (this.deck.length === 0) {
                    if (this.discardPile.length === 0) return;
                    this.deck = this.discardPile;
                    this.discardPile = [];
                    this.deck.sort(() => Math.random() - 0.5);
                }
                const card = this.deck.pop();
                player.hand.push(card);
                this.updateDeckCount();
            },

            startRound: function() {
                this.currentScore = CONFIG.START_SCORE;
                this.direction = 1;
                this.currentPlayerIndex = 0; // Starts with Red (Player 0)
                this.lastPlayerIndex = null;
                this.generateDeck();
                this.discardPile = [];
                this.isProcessing = false;

                // Deal Cards
                this.players.forEach(p => {
                    p.hand = [];
                    for(let i=0; i<CONFIG.HAND_SIZE; i++) this.drawCard(p);
                });

                document.getElementById('current-score').innerText = this.currentScore;
                document.getElementById('active-card-container').innerHTML = '';
                this.showToast(`Êñ∞Â±ÄÈñãÂßãÔºÅËµ∑ÂßãÊï∏Â≠ó 7`);
                this.updateUI();
                this.nextTurn();
            },

            // Render players in a circle
            renderCircularTable: function() {
                const container = document.getElementById('table-circle');
                // Keep center elements
                const centerChildren = Array.from(container.children).filter(c => c.classList.contains('center-stage'));
                container.innerHTML = '';
                centerChildren.forEach(c => container.appendChild(c));

                const radius = 42; // percentage
                const total = 7;
                
                this.players.forEach((p, i) => {
                    // Start from 90deg (bottom)
                    const angleDeg = 90 + (i * (360 / total));
                    const angleRad = angleDeg * (Math.PI / 180);
                    
                    const x = 50 + radius * Math.cos(angleRad);
                    const y = 50 + radius * Math.sin(angleRad);

                    const div = document.createElement('div');
                    div.id = `player-av-${i}`;
                    div.className = `player-avatar p${i}`;
                    div.style.left = `${x}%`;
                    div.style.top = `${y}%`;
                    div.style.borderColor = p.colorData.color;
                    div.style.transform = `translate(-50%, -50%)`;

                    div.innerHTML = `
                        <div style="font-size:24px;">üë§</div>
                        <div class="player-info-box">
                            <div class="avatar-name" style="color:${p.colorData.color}">${p.name}</div>
                            <div class="avatar-money">$${p.money}</div>
                            <div class="avatar-cards">üé¥ ${p.hand.length}</div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            },

            updateCircularUI: function() {
                this.players.forEach((p, i) => {
                    const el = document.getElementById(`player-av-${i}`);
                    if(!el) return;
                    
                    // Highlight active
                    if (i === this.currentPlayerIndex) {
                        el.classList.add('active');
                        el.style.boxShadow = `0 0 25px ${p.colorData.color}`;
                    } else {
                        el.classList.remove('active');
                        el.style.boxShadow = `0 4px 10px rgba(0,0,0,0.5)`;
                    }

                    // Update stats
                    el.querySelector('.avatar-money').innerText = `$${p.money}`;
                    el.querySelector('.avatar-cards').innerHTML = `üé¥ ${p.hand.length}`;
                });

                // Direction
                const ring = document.getElementById('direction-ring');
                const text = document.getElementById('direction-text');
                if (this.direction === 1) {
                    ring.style.animation = "spin 10s linear infinite";
                    text.innerText = "‚Üª È†ÜÊôÇÈáù";
                } else {
                    ring.style.animation = "spinCCW 10s linear infinite";
                    text.innerText = "‚Ü∫ ÈÄÜÊôÇÈáù";
                }
            },

            nextTurn: function() {
                this.updateUI();
                const player = this.players[this.currentPlayerIndex];

                if (!player.isHuman) {
                    this.isProcessing = true;
                    setTimeout(() => this.aiPlay(player), 1200);
                } else {
                    this.isProcessing = false;
                    this.showToast(`Ëº™Âà∞ ${player.name}`);
                }
            },

            calculateNewScore: function(card) {
                let tempScore = this.currentScore;
                
                if (card.effect === EFFECTS.SET99) return 99;
                if (card.effect === EFFECTS.SET0) return 0;
                if (card.effect === EFFECTS.SKIP) return tempScore;
                if (card.effect === EFFECTS.REMOVE) return tempScore;
                if (card.effect === EFFECTS.REVERSE) return tempScore;
                
                tempScore += card.value;
                return tempScore;
            },

            playCardIndex: function(cardIndex) {
                if (this.isProcessing) return;
                const player = this.players[this.currentPlayerIndex];
                if (!player.isHuman) return;

                const card = player.hand[cardIndex];
                const predictedScore = this.calculateNewScore(card);

                if (predictedScore > CONFIG.MAX_SCORE) {
                    this.executeMove(player, cardIndex, predictedScore, true);
                } else {
                    this.executeMove(player, cardIndex, predictedScore, false);
                }
            },

            aiPlay: function(player) {
                let validMoves = [];
                let bustMoves = [];

                player.hand.forEach((card, index) => {
                    let s = this.calculateNewScore(card);
                    if (s <= CONFIG.MAX_SCORE) {
                        validMoves.push({index, card, score: s});
                    } else {
                        bustMoves.push({index, card, score: s});
                    }
                });

                if (validMoves.length > 0) {
                    // Sort valid moves to find best aggressive move
                    validMoves.sort((a, b) => b.score - a.score);
                    const bestMove = validMoves[0];
                    this.executeMove(player, bestMove.index, bestMove.score, false);
                } else {
                    this.executeMove(player, bustMoves[0].index, bustMoves[0].score, true);
                }
            },

            executeMove: function(player, cardIndex, newScore, isBust) {
                const card = player.hand[cardIndex];
                player.hand.splice(cardIndex, 1);
                this.discardPile.push(card);

                // Show Played Card in Center
                this.displayPlayedCard(card, player.colorData.color);

                // Special Actions
                let logMsg = `${player.name} Âá∫Áâå: ${card.label}`;
                let nextPlayerIndex = this.getNextPlayerIndex();

                if (card.effect === EFFECTS.REVERSE) {
                    this.direction *= -1;
                    logMsg += " (Ëø¥ËΩâ)";
                    nextPlayerIndex = this.getNextPlayerIndex(); // Recalculate
                } else if (card.effect === EFFECTS.SKIP) {
                    logMsg += " (Ë∑≥ÈÅé)";
                } else if (card.effect === EFFECTS.REMOVE) {
                    // Remove card from NEXT player
                    const victim = this.players[nextPlayerIndex];
                    if (victim.hand.length > 0) {
                        const randIdx = Math.floor(Math.random() * victim.hand.length);
                        const removed = victim.hand.splice(randIdx, 1)[0];
                        this.discardPile.push(removed);
                        logMsg += ` -> ÊäΩËµ∞ ${victim.name} ‰∏ÄÂºµÁâå!`;
                        this.showToast(`üíî ${victim.name} Ë¢´ÊäΩËµ∞‰∫Ü‰∏ÄÂºµÁâå!`);
                    } else {
                        logMsg += " (‰∏ãÂÆ∂ÁÑ°ÁâåÂèØÊäΩ)";
                    }
                }

                if (isBust) {
                    this.showToast(`${player.name} Êï∏Â≠ó ${newScore} ÁàÜ‰∫Ü!`);
                    setTimeout(() => this.handleRoundLoss(player, newScore), 1000);
                } else {
                    this.currentScore = newScore;
                    document.getElementById('current-score').innerText = this.currentScore;
                    
                    const scoreEl = document.getElementById('current-score');
                    if(this.currentScore >= 90) scoreEl.style.color = "#FF5252";
                    else if(this.currentScore >= 50) scoreEl.style.color = "#FFEB3B";
                    else scoreEl.style.color = "#fff";

                    this.showToast(logMsg);
                    
                    this.drawCard(player);

                    this.lastPlayerIndex = this.currentPlayerIndex;
                    this.advancePlayer();
                    this.nextTurn();
                }
            },

            displayPlayedCard: function(card, borderColor) {
                const container = document.getElementById('active-card-container');
                container.innerHTML = `
                    <div class="card card-played" style="border-color:${borderColor}; color:${this.getCardColor(card)}; background:${card.type === 'effect' ? '#E3F2FD' : 'white'}">
                        <div class="card-top">${card.label}</div>
                        <div class="card-center">${card.label}</div>
                        <div class="card-bottom">${card.label}</div>
                    </div>
                `;
            },

            getCardColor: function(card) {
                if(card.type === 'pos') return '#2E7D32';
                if(card.type === 'neg') return '#C62828';
                return '#1565C0';
            },

            getNextPlayerIndex: function() {
                let idx = this.currentPlayerIndex + this.direction;
                if (idx >= 7) idx = 0;
                if (idx < 0) idx = 6;
                return idx;
            },

            advancePlayer: function() {
                this.currentPlayerIndex = this.getNextPlayerIndex();
            },

            showToast: function(msg) {
                const t = document.getElementById('toast-log');
                t.innerText = msg;
                t.classList.remove('hidden');
            },

            updateUI: function() {
                this.updateCircularUI();
                this.updateHandUI();
                this.updateDeckCount();
            },

            updateHandUI: function() {
                const handContainer = document.getElementById('player-hand');
                handContainer.innerHTML = '';
                
                const activePlayer = this.players[this.currentPlayerIndex];
                
                if (activePlayer.isHuman) {
                    activePlayer.hand.forEach((card, idx) => {
                        const cardDiv = document.createElement('div');
                        cardDiv.className = `card`;
                        cardDiv.setAttribute('data-type', card.type);
                        cardDiv.onclick = () => this.playCardIndex(idx);
                        
                        cardDiv.innerHTML = `
                            <div class="card-top">${card.label}</div>
                            <div class="card-center">${card.label}</div>
                            <div class="card-bottom">${card.label}</div>
                        `;
                        handContainer.appendChild(cardDiv);
                    });
                } else {
                    handContainer.innerHTML = `<div style="color:#aaa; padding:20px; font-size:16px;">${activePlayer.name} ÊÄùËÄÉ‰∏≠...</div>`;
                }
            },

            handleRoundLoss: function(loser, finalScore) {
                const multiplier = Math.floor(Math.random() * 3) + 1;
                const penalty = finalScore * multiplier;

                let winner = null;
                if (this.lastPlayerIndex !== null) {
                    winner = this.players[this.lastPlayerIndex];
                }

                loser.money -= penalty;
                let winnerText = "ÁÑ°‰∫∫";
                if (winner) {
                    winner.money += penalty;
                    winnerText = winner.name;
                }

                const ui = document.getElementById('round-result-screen');
                const details = document.getElementById('result-details');
                ui.classList.remove('hidden');

                details.innerHTML = `
                    <h3 style="color:${loser.colorData.color}">Ëº∏ÂÆ∂: ${loser.name}</h3>
                    <p>ÁàÜÊéâÊï∏Â≠ó: ${finalScore}</p>
                    <p>Èö®Ê©üÂÄçÁéá: x${multiplier}</p>
                    <p style="font-size:21px; color:#ff5252; margin:10px 0;">Á∏ΩÁΩ∞Ê¨æ: $${penalty}</p>
                    <hr style="border:1px solid #555; margin:10px 0;">
                    <p>Áç≤Âà©ËÄÖ: <span style="color:${winner ? winner.colorData.color : '#fff'}">${winnerText}</span></p>
                `;

                if (this.checkGameOver()) {
                    ui.classList.add('hidden');
                }
            },

            checkGameOver: function() {
                const richPlayer = this.players.find(p => p.money >= CONFIG.WIN_MONEY);
                const bankruptPlayer = this.players.find(p => p.money <= CONFIG.LOSE_MONEY);
                
                if (richPlayer || bankruptPlayer) {
                    let reason = richPlayer ? `${richPlayer.name} Ë¥èÂæó‰∫ÜË∂ÖÈÅé $2000ÔºÅ` : `${bankruptPlayer.name} Ëº∏ÂÖâ‰∫ÜÊâÄÊúâÈå¢ÔºÅ`;
                    this.showGameOver(reason);
                    return true;
                }
                return false;
            },

            showGameOver: function(reason) {
                const screen = document.getElementById('game-over-screen');
                screen.classList.remove('hidden');
                document.getElementById('winner-announce').innerText = reason;

                let tableHtml = `<table><thead><tr><th>ÂêçÊ¨°</th><th>Áé©ÂÆ∂</th><th>ÊúÄÁµÇÈáëÈ°ç</th></tr></thead><tbody>`;
                const sortedPlayers = [...this.players].sort((a,b) => b.money - a.money);
                
                sortedPlayers.forEach((p, idx) => {
                    tableHtml += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td style="color:${p.colorData.color}">${p.name}</td>
                            <td>$${p.money}</td>
                        </tr>
                    `;
                });
                tableHtml += `</tbody></table>`;
                document.getElementById('final-stats').innerHTML = tableHtml;
            },

            nextRound: function() {
                document.getElementById('round-result-screen').classList.add('hidden');
                this.startRound();
            }
        };
    </script>
</body>
</html>
